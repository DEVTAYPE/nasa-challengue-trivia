# üéÆ Integraci√≥n Completa del Componente Trivia con Zustand

## ‚úÖ Problemas Resueltos

### 1. **Preguntas Repetidas en Todos los Niveles**

**Problema:** Todas las trivias mostraban las mismas preguntas sin importar el cultivo o nivel seleccionado.

**Soluci√≥n:**

- Eliminada la dependencia de `triviaQuestions` (data est√°tica)
- Ahora usa `currentQuestions` del store de Zustand
- Las preguntas se cargan autom√°ticamente al llamar `startLevel(levelId)`
- El store filtra las preguntas por `cropType` y `levelId`

```typescript
// ANTES (incorrecto)
import { triviaQuestions } from "./trivia-contants";
const currentQuestion = triviaQuestions[currentQuestion];

// DESPU√âS (correcto)
const currentQuestions = useGameStore((state) => state.currentQuestions);
const currentQuestion = currentQuestions[currentQuestionIndex];
```

### 2. **Icono del Cultivo Hardcodeado**

**Problema:** Siempre mostraba el icono de papa sin importar el cultivo seleccionado.

**Soluci√≥n:**

- Renderizado condicional seg√∫n `session.selectedCrop`
- Usa los iconos correctos para cada cultivo: corn, potato, quinoa

```typescript
// ANTES (incorrecto)
<GameEntryIcons.potato className="..." />;

// DESPU√âS (correcto)
{
  session.selectedCrop === "corn" && <GameEntryIcons.corn className="..." />;
}
{
  session.selectedCrop === "potato" && (
    <GameEntryIcons.potato className="..." />
  );
}
{
  session.selectedCrop === "quinoa" && (
    <GameEntryIcons.quinoa className="..." />
  );
}
```

---

## üì¶ Cambios Implementados

### **Archivo: `page-trivia.tsx`**

#### 1. Imports Actualizados

```typescript
// Eliminados
import { useState } from "react";
import { triviaQuestions } from "./trivia-contants";

// A√±adidos
import { useEffect } from "react";
import { useGameStore, CROPS } from "@/core";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
```

#### 2. Estado del Componente

```typescript
// ANTES: Estado local
const [currentQuestion, setCurrentQuestion] = useState(0);
const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
const [score, setScore] = useState(0);
const [correctAnswers, setCorrectAnswers] = useState(0);
const [cornGrowth, setCornGrowth] = useState(0);

// DESPU√âS: Estado desde Zustand Store
const session = useGameStore((state) => state.session);
const currentQuestions = useGameStore((state) => state.currentQuestions);
const currentQuestionIndex = useGameStore(
  (state) => state.currentQuestionIndex
);
const selectedAnswer = useGameStore((state) => state.selectedAnswer);
const showFeedback = useGameStore((state) => state.showFeedback);
const answers = useGameStore((state) => state.answers);
```

#### 3. Acciones del Store

```typescript
const selectAnswer = useGameStore((state) => state.selectAnswer);
const submitAnswer = useGameStore((state) => state.submitAnswer);
const nextQuestion = useGameStore((state) => state.nextQuestion);
const finishLevel = useGameStore((state) => state.finishLevel);
```

#### 4. Validaci√≥n de Sesi√≥n y Preguntas

```typescript
useEffect(() => {
  if (!session) {
    toast.error("No hay sesi√≥n activa. Redirigiendo...");
    router.push("/game-entry");
    return;
  }

  if (currentQuestions.length === 0) {
    toast.error("No hay preguntas cargadas. Redirigiendo...");
    router.push("/dashboard-game");
  }
}, [session, currentQuestions, router]);
```

#### 5. C√°lculos Derivados

```typescript
const currentQuestion = currentQuestions[currentQuestionIndex];
const correctAnswers = answers.filter((a) => a.isCorrect).length;
const score = correctAnswers * 20;
const progress = (correctAnswers / currentQuestions.length) * 100;
const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
```

#### 6. Handlers Actualizados

```typescript
const handleAnswerSelect = (answerIndex: number) => {
  if (showFeedback) return;
  selectAnswer(answerIndex); // Llama al store
};

const handleSubmit = async () => {
  if (selectedAnswer === null) return;
  await submitAnswer(); // Verifica respuesta y guarda

  setTimeout(() => {
    if (currentQuestionIndex < currentQuestions.length - 1) {
      nextQuestion(); // Avanza a la siguiente
    }
    // Si es la √∫ltima, el componente detecta isFinished
  }, 2500);
};

const handleRestart = async () => {
  const currentLevel = session.cropProgress[session.selectedCrop!].currentLevel;
  const startLevel = useGameStore.getState().startLevel;
  await startLevel(currentLevel); // Recarga las preguntas
};
```

#### 7. Detecci√≥n de Fin de Nivel

```typescript
const isFinished =
  currentQuestionIndex >= currentQuestions.length &&
  answers.length === currentQuestions.length;
```

#### 8. T√≠tulo Din√°mico

```typescript
<h1>Trivia de Agricultura</h1>
<p>
  Cultivo de {CROPS[session.selectedCrop!].name} -
  Nivel {session.cropProgress[session.selectedCrop!].currentLevel}
</p>
```

#### 9. Icono del Cultivo Din√°mico

```typescript
{
  /* Renderizar seg√∫n cultivo seleccionado */
}
{
  session.selectedCrop === "corn" && (
    <GameEntryIcons.corn
      className="relative animate-bounce w-16 h-16"
      style={{ animationDuration: "2s" }}
    />
  );
}
{
  session.selectedCrop === "potato" && (
    <GameEntryIcons.potato
      className="relative animate-bounce w-16 h-16"
      style={{ animationDuration: "2s" }}
    />
  );
}
{
  session.selectedCrop === "quinoa" && (
    <GameEntryIcons.quinoa
      className="relative animate-bounce w-16 h-16"
      style={{ animationDuration: "2s" }}
    />
  );
}
```

#### 10. Referencias Actualizadas

```typescript
// Progreso
{currentQuestionIndex + 1}/{currentQuestions.length}

// Pregunta actual
Pregunta {currentQuestionIndex + 1}
{currentQuestion.question}

// Opciones
{currentQuestion.options.map((option, index) => ...)}

// Explicaci√≥n
{currentQuestion.explanation}

// Progreso visual
{Math.round(progress)}%

// Marcadores
{[...Array(currentQuestions.length)].map((_, i) => ...)}
```

---

### **Archivo: `trivia-finish-result.tsx`**

#### Tipo Actualizado

```typescript
// ANTES
import { IQuestion } from "./trivia-contants";
interface TriviaFinishResultProps {
  questions: Array<IQuestion>;
}

// DESPU√âS
import { Question } from "@/core";
interface TriviaFinishResultProps {
  questions: Array<Question>;
}
```

---

## üîÑ Flujo Completo Actualizado

### 1Ô∏è‚É£ Usuario en Dashboard

```
Usuario click en Nivel 2 del cultivo Ma√≠z
‚îî‚îÄ> LevelSelectDetail.handleStartLevel()
    ‚îî‚îÄ> await startLevel(2)
        ‚îî‚îÄ> Store carga 5 preguntas de ma√≠z nivel 2
        ‚îî‚îÄ> router.push("/dashboard-game/2")
```

### 2Ô∏è‚É£ Componente Trivia Monta

```
useEffect() valida:
‚îú‚îÄ> ¬øHay sesi√≥n? ‚Üí S√≠ ‚úì
‚îú‚îÄ> ¬øHay preguntas? ‚Üí S√≠ (5 preguntas de ma√≠z nivel 2) ‚úì
‚îî‚îÄ> Renderiza trivia correcta
```

### 3Ô∏è‚É£ Usuario Responde Pregunta

```
1. Usuario selecciona opci√≥n ‚Üí selectAnswer(2)
2. Usuario click "Confirmar" ‚Üí await submitAnswer()
   ‚îú‚îÄ> Store verifica si es correcta
   ‚îú‚îÄ> Guarda en answers[]
   ‚îú‚îÄ> Actualiza score
   ‚îî‚îÄ> showFeedback = true
3. Espera 2.5 segundos
4. nextQuestion()
   ‚îî‚îÄ> currentQuestionIndex++
   ‚îî‚îÄ> selectedAnswer = null
   ‚îî‚îÄ> showFeedback = false
```

### 4Ô∏è‚É£ √öltima Pregunta

```
Usuario responde pregunta 5/5
‚îú‚îÄ> submitAnswer() guarda respuesta
‚îú‚îÄ> Espera 2.5 segundos
‚îú‚îÄ> No llama nextQuestion() (ya no hay m√°s)
‚îî‚îÄ> isFinished = true
    ‚îî‚îÄ> Renderiza TriviaFinishResult
```

### 5Ô∏è‚É£ Pantalla de Resultados

```
TriviaFinishResult muestra:
‚îú‚îÄ> Score: 80 pts (4 correctas √ó 20)
‚îú‚îÄ> Correctas: 4/5
‚îú‚îÄ> Incorrectas: 1/5
‚îî‚îÄ> Botones:
    ‚îú‚îÄ> "Reintentar" ‚Üí startLevel(2) recarga preguntas
    ‚îî‚îÄ> "Volver al Mapa" ‚Üí finishLevel() + router.push("/dashboard-game")
```

### 6Ô∏è‚É£ Regreso al Dashboard

```
finishLevel() ejecuta:
‚îú‚îÄ> Calcula score final
‚îú‚îÄ> Marca nivel 2 como "completed"
‚îú‚îÄ> Desbloquea nivel 3
‚îú‚îÄ> Guarda en localStorage
‚îî‚îÄ> Dashboard se actualiza autom√°ticamente
```

---

## üéØ Verificaci√≥n de Funcionalidad

### ‚úÖ Cultivo de Ma√≠z - Nivel 1

```
Preguntas esperadas: 5 preguntas sobre conceptos b√°sicos de ma√≠z
Icono: üåΩ (ma√≠z)
T√≠tulo: "Cultivo de Ma√≠z - Nivel 1"
```

### ‚úÖ Cultivo de Papa - Nivel 3

```
Preguntas esperadas: 5 preguntas sobre fertilizaci√≥n de papa
Icono: ü•î (papa)
T√≠tulo: "Cultivo de Papa - Nivel 3"
```

### ‚úÖ Cultivo de Quinoa - Nivel 6

```
Preguntas esperadas: 5 preguntas sobre sat√©lites NASA para quinoa
Icono: üåæ (quinoa)
T√≠tulo: "Cultivo de Quinoa - Nivel 6"
```

---

## üìä Ejemplo de Data Flow

### Ma√≠z - Nivel 1

```typescript
// Usuario click en nivel 1
await startLevel(1);

// Store ejecuta:
const questions = questionRepository.getQuestionsByCropAndLevel("corn", 1);
// Resultado:
[
  {
    id: "corn-1-1",
    cropType: "corn",
    levelId: 1,
    question: "¬øCu√°l es el nombre cient√≠fico del ma√≠z?",
    options: [...],
    correctAnswer: 1,
    explanation: "El ma√≠z pertenece a la especie Zea mays..."
  },
  // ... 4 preguntas m√°s
]
```

### Papa - Nivel 4

```typescript
await startLevel(4);

const questions = questionRepository.getQuestionsByCropAndLevel("potato", 4);
// Resultado:
[
  {
    id: "potato-4-1",
    cropType: "potato",
    levelId: 4,
    question: "¬øQu√© sat√©lite NASA mide la humedad del suelo?",
    options: [...],
    correctAnswer: 2,
    explanation: "SMAP es el sat√©lite especializado..."
  },
  // ... 4 preguntas m√°s
]
```

---

## üêõ Problemas Corregidos

1. ‚úÖ **Preguntas repetidas** ‚Üí Ahora filtra por cultivo y nivel
2. ‚úÖ **Icono hardcodeado** ‚Üí Renderiza seg√∫n `session.selectedCrop`
3. ‚úÖ **Variables obsoletas** ‚Üí Eliminado `cornGrowth`, `triviaQuestions`
4. ‚úÖ **Estado local** ‚Üí Migrado todo al store de Zustand
5. ‚úÖ **Tipos incorrectos** ‚Üí Actualizado `IQuestion` a `Question`
6. ‚úÖ **T√≠tulo est√°tico** ‚Üí Muestra cultivo y nivel din√°micamente
7. ‚úÖ **Sin validaci√≥n** ‚Üí Verifica sesi√≥n y preguntas antes de renderizar
8. ‚úÖ **Progreso incorrecto** ‚Üí Calculado desde `answers.filter()`

---

## üéâ Resultado Final

Ahora el componente de trivia:

1. ‚úÖ **Carga preguntas correctas** seg√∫n cultivo y nivel seleccionado
2. ‚úÖ **Muestra icono correcto** del cultivo
3. ‚úÖ **Valida sesi√≥n activa** antes de renderizar
4. ‚úÖ **Guarda progreso** en localStorage autom√°ticamente
5. ‚úÖ **Desbloquea siguiente nivel** al completar
6. ‚úÖ **Sincroniza con dashboard** al regresar
7. ‚úÖ **Usa arquitectura hexagonal** del core
8. ‚úÖ **Mantiene estado en Zustand** para consistencia

**¬°Todo funcional y listo para jugar!** üöÄ

---

## üß™ Para Probar

1. Inicia en `/game-entry` ‚Üí Selecciona Ma√≠z
2. Dashboard ‚Üí Click en Nivel 1
3. **Verifica:**
   - T√≠tulo dice "Cultivo de Ma√≠z - Nivel 1"
   - Icono es üåΩ
   - Preguntas son sobre ma√≠z b√°sico
4. Completa las 5 preguntas
5. Click "Volver al Mapa"
6. **Verifica:**
   - Nivel 1 marcado como completado
   - Nivel 2 desbloqueado
7. Cambia a Papa en el popover
8. Click en Nivel 1 de Papa
9. **Verifica:**
   - T√≠tulo dice "Cultivo de Papa - Nivel 1"
   - Icono es ü•î
   - Preguntas son sobre papa (diferentes a ma√≠z)

¬°Todo deber√≠a funcionar perfectamente! üéÆ
